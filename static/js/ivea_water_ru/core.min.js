var Skaip = Skaip || {};
Skaip.buttons = new (function () {
  var r = this,
    j = {},
    c = {};
  r.config = {
    commands: "*",
    size: 14,
    status: "off",
    theme: "logo",
    language: null,
    bgcolor: "#2a92f3",
  };
  var p = {
    en: {
      online: "Online",
      away: "Away",
      busy: "Do Not Disturb",
      offline: "Offline",
      unknown: "Unknown",
      status_title: "Status",
      cmd_chat: "Chat",
      cmd_call: "Call",
      cmd_videocall: "Videocall",
      cmd_voicemail: "Voice message",
      cmd_add: "Add to Contacts",
      cmd_userinfo: "Information",
      cmd_sendfile: "Send file",
      cmd_webchat: "Web chat",
    },
    ja: {
      online: "オンライン",
      away: "アウェイ",
      busy: "邪魔しないでください",
      offline: "オフライン",
      unknown: "道の",
      status_title: "状態",
      cmd_chat: "チャット",
      cmd_call: "コール",
      cmd_videocall: "ビデオ通話",
      cmd_voicemail: "ボイスメッセージ",
      cmd_add: "連絡先に登録する",
      cmd_userinfo: "情報",
      cmd_sendfile: "ファイルを送信",
      cmd_webchat: "Webチャット",
    },
    ru: {
      online: "В сети",
      away: "Нет на месте",
      busy: "Не беспокоить",
      offline: "Не в сети",
      unknown: "Неизвестно",
      status_title: "Сетевой статус",
      cmd_chat: "Чат",
      cmd_call: "Аудиозвонок",
      cmd_videocall: "Видеозвонок",
      cmd_voicemail: "Голосовое сообщение",
      cmd_add: "Добавить в контакты",
      cmd_userinfo: "Информация",
      cmd_sendfile: "Отправить файл",
      cmd_webchat: "Веб-чат",
    },
  };
  var w = {
    "www.skaip.su": "ru",
    "www.skaip.rus": "ru",
    "www.skaip.org": "en",
    "www.skaip.eng": "en",
  };
  function h(J) {
    var G = {};
    if (J.getAttribute("data-config")) {
      for (
        var I = 0, F = J.getAttribute("data-config").split(";");
        I < F.length;
        I++
      ) {
        var K = F[I].split("="),
          H = K[0],
          L = K[1];
        if (H && L) {
          G[H] = L;
        }
      }
    }
    return G;
  }
  function l(H, I) {
    var F = H;
    for (var G in I) {
      if (F[G] === undefined) {
        F[G] = I[G];
      }
    }
    return F;
  }
  function a(F) {
    return document.getElementById(F);
  }
  function E(F, G) {
    if (!G) {
      var G = r.config.language;
    }
    if (p[G]) {
      return p[G][F];
    } else {
      console.error("Skaip.buttons missing language string: " + F, G);
    }
  }
  function n(G) {
    var H = w[G.hostname];
    if (!H) {
      return false;
    }
    if (typeof SkaipButtonsLanguages === "object") {
      for (var F in SkaipButtonsLanguages) {
        p[F] = SkaipButtonsLanguages[F];
      }
    }
    r.config.language = H;
    r.config.hostname = G.hostname;
    return true;
  }
  function i() {
    var F = a("skaip-buttons");
    if (!F) {
      F = a("skaipsu-buttons");
    }
    if (F) {
      if (!F.getAttribute("rel") && n(F)) {
        F.style.display = "none";
        return l(h(F), r.config);
      }
    }
  }
  function C(F, K) {
    var H = parseInt(F.slice(1), 16),
      N = Math.round(2.55 * K),
      J = (H >> 16) + N,
      I = ((H >> 8) & 255) + N,
      M = (H & 255) + N,
      L =
        "#" +
        (
          16777216 +
          (J < 255 ? (J < 1 ? 0 : J) : 255) * 65536 +
          (I < 255 ? (I < 1 ? 0 : I) : 255) * 256 +
          (M < 255 ? (M < 1 ? 0 : M) : 255)
        )
          .toString(16)
          .slice(1);
    if (L === F) {
      return C(F, -K);
    } else {
      return L;
    }
  }
  function A(G) {
    var F = r.config.hostname;
    if (G) {
      return F.replace("www", G);
    } else {
      return F;
    }
  }
  function s(I) {
    var F =
      "@class-wrapper{position:relative;clear:both;text-align:left}@class-icon{display:inline-block;background-position:left center;background-repeat:no-repeat;vertical-align:middle;margin-top:-2px;margin-right:3px}@class-status-skype @class-icon{background-position:0 0}@class-size-14 @class-icon{height:14px;width:14px}@class-size-22 @class-icon{height:22px;width:22px}@class-size-30 @class-icon{width:30px;height:30px}@class-theme-logo@class-size-14 @class-icon{background-image:url(%uri%/widget/img/themes/logo/14.png)}@class-theme-logo@class-size-22 @class-icon{background-image:url(%uri%/widget/img/themes/logo/22.png)}@class-theme-logo@class-size-30 @class-icon{background-image:url(%uri%/widget/img/themes/logo/30.png)}@class-size-14 @class-status-online @class-icon{background-position:0 -14px}@class-size-14 @class-status-away @class-icon{background-position:0 -28px}@class-size-14 @class-status-busy @class-icon{background-position:0 -42px}@class-size-14 @class-status-offline @class-icon{background-position:0 -56px}@class-size-14 @class-status-unknown @class-icon{background-position:0 -70px}@class-size-22 @class-status-online @class-icon{background-position:0 -22px}@class-size-22 @class-status-away @class-icon{background-position:0 -44px}@class-size-22 @class-status-busy @class-icon{background-position:0 -66px}@class-size-22 @class-status-offline @class-icon{background-position:0 -88px}@class-size-22 @class-status-unknown @class-icon{background-position:0 -110px}@class-size-30 @class-status-online @class-icon{background-position:0 -30px}@class-size-30 @class-status-away @class-icon{background-position:0 -60px}@class-size-30 @class-status-busy @class-icon{background-position:0 -90px}@class-size-30 @class-status-offline @class-icon{background-position:0 -120px}@class-size-30 @class-status-unknown @class-icon{background-position:0 -150px}@class-arrow{display:inline-block;font-family:monospace;font-size:14px;margin-left:0;padding:0;font-weight:normal}@class-container{background-color:" +
      I.bgcolor +
      ";display:none;position:absolute;margin-top:5px;z-index:9999;box-shadow:0 0 4px #000;line-height:18px;top:18px}@class-size-14 @class-container{left:16px}@class-size-22 @class-container{left:24px}@class-size-30 @class-container{left:32px}@class-container a{text-decoration:none;padding:4px 7px 4px 25px;display:block;white-space:pre;border:none;border-bottom:1px solid " +
      C(I.bgcolor, 10) +
      ";background-position:4px center;background-repeat:no-repeat}@class-container a,@class-container a:visited,@class-container a:link,@class-container a:active{color:#fff;font-size:12px;font-family:Verdana;line-height:18px}@class-container a:hover{background-color:" +
      C(I.bgcolor, -10) +
      "}@class-cmd-chat{background-image:url(%uri%/widget/img/cmd/chat.png)}@class-cmd-call{background-image:url(%uri%/widget/img/cmd/call.png)}@class-cmd-videocall{background-image:url(%uri%/widget/img/cmd/videocall.png)}@class-cmd-voicemail{background-image:url(%uri%/widget/img/cmd/voicemail.png)}@class-cmd-add{background-image:url(%uri%/widget/img/cmd/add.png)}@class-cmd-userinfo{background-image:url(%uri%/widget/img/cmd/userinfo.png)}@class-cmd-sendfile{background-image:url(%uri%/widget/img/cmd/sendfile.png)}@class-cmd-webchat{background-image:url(%uri%/widget/img/cmd/webchat.png)}";
    var G = m("style", "css");
    G.type = "text/css";
    G.innerHTML = D(F.replace(/@class/g, ".skaip-buttons"));
    var H = document.getElementsByTagName("head");
    H = H.length ? H[0] : document.body;
    H.appendChild(G);
  }
  function D(G) {
    var F = "//" + A("apps") + "/buttons";
    return G.replace(/%uri%/g, F);
  }
  function q(H, G) {
    var F = document.createElement("a");
    F.href = x(H, G);
    F.className = "skaip-buttons-cmd-" + G.name;
    F.setAttribute("data-skaip-buttons", "off");
    F.innerHTML = G.text;
    if (G.callback) {
      z(F, "click", function (I) {
        G.callback(H, G, F);
        I.preventDefault();
        return false;
      });
    }
    return F;
  }
  function x(G, F) {
    if (F.uri) {
      return "skype:" + G + "?" + F.uri;
    } else {
      return "#";
    }
  }
  function z(H, G, F) {
    if (H.addEventListener) {
      H.addEventListener(G, F, false);
    } else {
      H.attachEvent("on" + G, F);
    }
  }
  function m(F, G) {
    var J = "skaip-buttons-uniqnode-" + G,
      I = a(J);
    if (I) {
      I.parentNode.removeChild(I);
    }
    var H = document.createElement(F);
    H.id = J;
    return H;
  }
  function f(G) {
    var F = m("script", "jsonp");
    F.src =
      "https://apps.skaip.org/status/?username=" +
      G +
      "&lang=" +
      r.config.language +
      "&ver=2";
    document.body.appendChild(F);
    Skaip.buttons.setStatus(G, "online");
  }
  function k(G, F) {
    if (F.username[0] !== "+") {
      if (!c[F.username]) {
        c[F.username] = { name: "unknown", links: [] };
        setTimeout(function () {
          f(F.username);
        }, 500);
      }
      c[F.username].links.push(G);
      b(G, "unknown");
    }
  }
  function b(H, G) {
    H.setAttribute("class", "skaip-buttons-status-" + G);
    var F = E(G, H.config.language);
    if (F) {
      var I = E("status_title", H.config.language);
      H.setAttribute("title", I + ': "' + F + '"');
    }
  }
  function g() {
    return '<span class="skaip-buttons-arrow">&#x25BE;</span>';
  }
  function B(H, F) {
    var I = document.createElement("span");
    if (H.nextSibling) {
      H.parentNode.insertBefore(I, H.nextSibling);
    } else {
      H.parentNode.appendChild(I);
    }
    var G = [
      "skaip-buttons-wrapper",
      "skaip-buttons-theme-" + F.theme,
      "skaip-buttons-size-" + F.size,
    ];
    I.setAttribute("class", G.join(" "));
    I.appendChild(H);
    return I;
  }
  function o(I, H) {
    I.onclick = function () {
      return false;
    };
    var G = document.createElement("span");
    G.className = "skaip-buttons-container";
    G.style.display = "none";
    z(document, "click", function (L) {
      if (!L.target || (L.target !== I && L.target.parentNode !== I)) {
        G.style.display = "none";
      }
    });
    z(I, "click", function () {
      var L = G.style.display === "none" ? "inline-block" : "none";
      G.style.display = L;
    });
    var F = r.getCommands(H.commands, H.language);
    for (var K = 0; K < F.length; K++) {
      var J = q(H.username, F[K]);
      G.appendChild(J);
    }
    I.href = x(H.username, F[0]);
    if (F.length > 1) {
      I.innerHTML += g();
    }
    return G;
  }
  function e(G) {
    var H = G.replace(/^skype:/gi, "").split("?"),
      F = {};
    if (H.length === 2 && H[1].indexOf("blob=") !== -1) {
      F.value = H[1].split("blob=")[1].split("&")[0];
      F.type = "blob";
    } else {
      F.value = H[0].split(";")[0].replace(/\s/g, "");
      F.type = H[0].indexOf("+") === 0 ? "phone" : "username";
    }
    return F;
  }
  function v(G, I) {
    var F = e(G.getAttribute("href"));
    if (F.value) {
      G.config = l(h(G), I);
      G.config.username = F.value;
      G.innerHTML =
        '<span class="skaip-buttons-icon"></span>' +
        (G.innerHTML ? G.innerHTML : G.config.username);
      G.setAttribute("data-skaip-buttons", "off");
      var H = B(G, G.config);
      b(G, "skype");
      if (G.config.commands && F.type !== "blob") {
        H.appendChild(o(G, G.config, H));
      }
      if (F.type === "username" && G.config.status === "on") {
        k(G, G.config);
      }
    }
  }
  function u() {
    var J = i();
    if (J) {
      var G = document.getElementsByTagName("a");
      if (G) {
        var F = [];
        for (var I = 0; I < G.length; I++) {
          if (
            G[I].getAttribute("href") &&
            G[I].getAttribute("data-skaip-buttons") !== "off"
          ) {
            var H = G[I].getAttribute("href");
            if (H.indexOf("skype:") === 0) {
              F.push(G[I]);
            }
          }
        }
        if (F.length > 0) {
          s(J);
          for (var I = 0; I < F.length; I++) {
            v(F[I], J);
          }
        }
      }
    }
  }
  function y() {
    try {
      return typeof SkypeWebControl.SDK.Chat.startChat === "function";
    } catch (F) {}
  }
  function t(I, G, F) {
    if (y()) {
      SkypeWebControl.SDK.Chat.startChat({
        ConversationId: I,
        ConversationType: "person",
      });
    } else {
      if (!r.SkypeWebControlIncluded) {
        var H = document.createElement("script");
        H.src = "https://swc.cdn.skype.com/sdk/v1/sdk.min.js";
        document.body.appendChild(H);
        r.SkypeWebControlIncluded = true;
      }
      setTimeout(function () {
        t(I, G, F);
      }, 250);
    }
  }
  function d(F) {
    if (!j[F]) {
      j[F] = [
        { name: "chat", uri: "chat" },
        { name: "call", uri: "call" },
        { name: "videocall", uri: "call&video=true" },
        { name: "voicemail", uri: "voicemail" },
        { name: "add", uri: "add" },
        { name: "userinfo", uri: "userinfo" },
        { name: "sendfile", uri: "sendfile" },
        { name: "webchat", callback: t },
      ];
      for (var G = 0; G < j[F].length; G++) {
        j[F][G].text = E("cmd_" + j[F][G].name, F);
      }
    }
    return j[F];
  }
  this.getSizes = function () {
    return [14, 22, 30];
  };
  this.getThemes = function () {
    return ["logo"];
  };
  this.getCommands = function (H, I) {
    var G = d(I);
    if (!H.length || H === "*") {
      return G;
    } else {
      var F = [];
      for (var M = 0, K = H.split(","); M < K.length; M++) {
        for (var L = 0; L < G.length; L++) {
          var J = G[L];
          if (J.name === K[M]) {
            F.push(J);
          }
        }
      }
      return F;
    }
  };
  this.setStatus = function (I, F, G) {
    if (c[I]) {
      for (var H = 0; H < c[I].links.length; H++) {
        b(c[I].links[H], F);
      }
      delete c[I];
    }
  };
  this.setup = u;
  u();
})();
